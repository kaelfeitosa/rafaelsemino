<!DOCTYPE html>
<html>

<head>
    <title>AI Crop Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: #fff;
            text-align: center;
        }

        canvas {
            border: 2px solid var(--red);
            max-width: 90vw;
        }
    </style>
</head>

<body>
    <h1>AI Vision Cropper</h1>
    <div id="status">Loading Model...</div>
    <canvas id="viewer"></canvas>

    <script>
        const status = document.getElementById('status');
        const canvas = document.getElementById('viewer');
        const ctx = canvas.getContext('2d');
        let model;

        async function init() {
            model = await cocoSsd.load();
            status.innerText = "Model Ready. Send image path via URL ?img=...";

            const urlParams = new URLSearchParams(window.location.search);
            const imgPath = urlParams.get('img');

            if (imgPath) {
                analyze(imgPath);
            }
        }

        async function analyze(path) {
            status.innerText = "Analyzing: " + path;
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = path;

            img.onload = async () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                const predictions = await model.detect(img);
                const persons = predictions.filter(p => p.class === 'person');

                if (persons.length > 0) {
                    // Find a bounding box that covers all persons
                    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                    persons.forEach(p => {
                        const [x, y, w, h] = p.bbox;
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x + w);
                        maxY = Math.max(maxY, y + h);
                    });

                    const center = {
                        x: Math.round(minX + (maxX - minX) / 2),
                        y: Math.round(minY + (maxY - minY) / 2),
                        width: Math.round(maxX - minX),
                        height: Math.round(maxY - minY)
                    };

                    console.log("CROP_DATA:" + JSON.stringify(center));
                    status.innerText = "PERSON DETECTED!";

                    // Draw detection
                    ctx.strokeStyle = "#00FF00";
                    ctx.lineWidth = 10;
                    ctx.strokeRect(minX, minY, maxX - minX, maxY - minY);
                } else {
                    console.log("CROP_DATA:NONE");
                    status.innerText = "NO PERSON DETECTED. Using center crop.";
                }
            };
        }

        init();
    </script>
</body>

</html>