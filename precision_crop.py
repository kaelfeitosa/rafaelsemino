from PIL import Image
import os
import json

def apply_precision_crop(rel_path, crop_data):
    # rel_path e.g. "images/portfolio_rafael/page_1_img_1.jpeg"
    # crop_data e.g. {"x": 0, "y": 0, "width": 500, "height": 500}
    
    abs_input_path = os.path.join(os.getcwd(), rel_path.replace('/', os.sep))
    
    if not os.path.exists(abs_input_path):
        print(f"Error: {abs_input_path} not found")
        return

    try:
        img = Image.open(abs_input_path)
        c = crop_data
        
        # Ensure we don't crop out of bounds
        x = max(0, c['x'])
        y = max(0, c['y'])
        w = min(img.width - x, c['width'])
        h = min(img.height - y, c['height'])
        
        cropped = img.crop((x, y, x + w, y + h))
        
        # Prepare output path
        # images/portfolio/img.jpg -> images/cropped/portfolio/img.jpg
        parts = rel_path.split('/')
        # parts[0] is 'images'
        rel_subfolder = '/'.join(parts[1:-1])
        filename = parts[-1]
        
        output_dir = os.path.join(os.getcwd(), 'images', 'cropped', rel_subfolder.replace('/', os.sep))
        os.makedirs(output_dir, exist_ok=True)
        
        output_path = os.path.join(output_dir, filename)
        
        # Resize to consistent 800x800 for high quality previews
        resized = cropped.resize((800, 800), Image.Resampling.LANCZOS)
        resized.save(output_path, quality=95)
        print(f"Applied crop to: {rel_path}")
    except Exception as e:
        print(f"Failed to process {rel_path}: {e}")

# FULL DATASET FROM AI VISION AUDIT
full_results = {"images/portfolio_coletivo_farol_novo/page_10_img_1.jpeg":{"x":0,"y":0,"width":641,"height":847},"images/portfolio_coletivo_farol_novo/page_11_img_1.jpeg":{"x":0,"y":0,"width":858,"height":662},"images/portfolio_coletivo_farol_novo/page_12_img_1.jpeg":{"x":346,"y":339,"width":340,"height":340},"images/portfolio_coletivo_farol_novo/page_13_img_1.jpeg":{"x":0,"y":0,"width":648,"height":844},"images/portfolio_coletivo_farol_novo/page_14_img_1.jpeg":{"x":0,"y":0,"width":648,"height":866},"images/portfolio_coletivo_farol_novo/page_15_img_1.jpeg":{"x":0,"y":110,"width":648,"height":648},"images/portfolio_coletivo_farol_novo/page_16_img_1.jpeg":{"x":17,"y":13,"width":458,"height":458},"images/portfolio_coletivo_farol_novo/page_17_img_1.jpeg":{"x":51,"y":0,"width":707,"height":707},"images/portfolio_coletivo_farol_novo/page_18_img_1.jpeg":{"x":0,"y":130,"width":465,"height":465},"images/portfolio_coletivo_farol_novo/page_1_img_1.jpeg":{"x":0,"y":1,"width":392,"height":392},"images/portfolio_coletivo_farol_novo/page_2_img_1.jpeg":{"x":0,"y":0,"width":864,"height":576},"images/portfolio_coletivo_farol_novo/page_2_img_2.jpeg":{"x":0,"y":0,"width":850,"height":566},"images/portfolio_coletivo_farol_novo/page_3_img_1.jpeg":{"x":0,"y":0,"width":816,"height":576},"images/portfolio_coletivo_farol_novo/page_4_img_1.jpeg":{"x":0,"y":0,"width":1008,"height":672},"images/portfolio_coletivo_farol_novo/page_4_img_2.jpeg":{"x":0,"y":0,"width":850,"height":566},"images/portfolio_coletivo_farol_novo/page_5_img_1.jpeg":{"x":0,"y":0,"width":613,"height":1029},"images/portfolio_coletivo_farol_novo/page_5_img_2.jpeg":{"x":0,"y":0,"width":966,"height":1242},"images/portfolio_coletivo_farol_novo/page_6_img_1.jpeg":{"x":218,"y":253,"width":601,"height":601},"images/portfolio_coletivo_farol_novo/page_6_img_2.jpeg":{"x":0,"y":0,"width":434,"height":511},"images/portfolio_coletivo_farol_novo/page_6_img_3.jpeg":{"x":0,"y":0,"width":376,"height":960},"images/portfolio_coletivo_farol_novo/page_7_img_1.jpeg":{"x":0,"y":145,"width":848,"height":945},"images/portfolio_coletivo_farol_novo/page_7_img_2.jpeg":{"x":0,"y":0,"width":686,"height":1296},"images/portfolio_coletivo_farol_novo/page_7_img_3.jpeg":{"x":0,"y":0,"width":884,"height":537},"images/portfolio_coletivo_farol_novo/page_8_img_1.jpeg":{"x":0,"y":0,"width":486,"height":621},"images/portfolio_coletivo_farol_novo/page_9_img_1.jpeg":{"x":0,"y":0,"width":512,"height":745},"images/portfolio_rafael/page_11_img_1.jpeg":{"x":0,"y":0,"width":1120,"height":630},"images/portfolio_rafael/page_12_img_1.jpeg":{"x":0,"y":0,"width":960,"height":540},"images/portfolio_rafael/page_14_img_1.jpeg":{"x":96,"y":0,"width":1177,"height":908},"images/portfolio_rafael/page_14_img_2.jpeg":{"x":151,"y":0,"width":1049,"height":924},"images/portfolio_rafael/page_14_img_3.jpeg":{"x":0,"y":0,"width":1386,"height":924},"images/portfolio_rafael/page_14_img_4.jpeg":{"x":96,"y":0,"width":1177,"height":908},"images/portfolio_rafael/page_19_img_2.jpeg":{"x":0,"y":0,"width":1141,"height":1711},"images/portfolio_rafael/page_1_img_1.jpeg":{"x":0,"y":0,"width":520,"height":754},"images/portfolio_rafael/page_1_img_2.jpeg":{"x":0,"y":0,"width":935,"height":701},"images/portfolio_rafael/page_20_img_1.jpeg":{"x":0,"y":0,"width":538,"height":717},"images/portfolio_rafael/page_20_img_2.jpeg":{"x":0,"y":66,"width":538,"height":651},"images/portfolio_rafael/page_2_img_1.jpeg":{"x":0,"y":0,"width":1152,"height":1728},"images/portfolio_rafael/page_4_img_1.jpeg":{"x":0,"y":0,"width":819,"height":941},"images/portfolio_rafael/page_5_img_1.jpeg":{"x":0,"y":0,"width":1152,"height":1728},"images/portfolio_rafael/page_6_img_1.jpeg":{"x":190,"y":0,"width":1311,"height":1155},"images/portfolio_rafael/page_10_img_1.png":{"x":0,"y":282,"width":864,"height":1277},"images/portfolio_rafael/page_10_img_2.png":{"x":0,"y":197,"width":756,"height":1042},"images/portfolio_rafael/page_13_img_1.png":{"x":0,"y":613,"width":1053,"height":1053},"images/portfolio_rafael/page_13_img_2.png":{"x":0,"y":141,"width":702,"height":1318},"images/portfolio_rafael/page_15_img_1.png":{"x":0,"y":409,"width":702,"height":702},"images/portfolio_rafael/page_15_img_2.png":{"x":0,"y":800,"width":1067,"height":1067},"images/portfolio_rafael/page_15_img_3.png":{"x":0,"y":613,"width":1053,"height":1053},"images/portfolio_rafael/page_15_img_4.png":{"x":0,"y":409,"width":702,"height":702},"images/portfolio_rafael/page_16_img_1.png":{"x":0,"y":945,"width":862,"height":862},"images/portfolio_rafael/page_16_img_2.png":{"x":34,"y":881,"width":560,"height":560},"images/portfolio_rafael/page_17_img_1.png":{"x":0,"y":79,"width":648,"height":967},"images/portfolio_rafael/page_17_img_2.png":{"x":0,"y":25,"width":648,"height":1130},"images/portfolio_rafael/page_17_img_3.png":{"x":0,"y":0,"width":540,"height":1080},"images/portfolio_rafael/page_18_img_1.png":{"x":0,"y":116,"width":756,"height":1083},"images/portfolio_rafael/page_18_img_2.png":{"x":0,"y":46,"width":1080,"height":1554},"images/portfolio_rafael/page_19_img_1.png":{"x":0,"y":56,"width":648,"height":1170},"images/portfolio_rafael/page_20_img_3.png":{"x":0,"y":690,"width":1053,"height":1157},"images/portfolio_rafael/page_21_img_1.png":{"x":0,"y":465,"width":1053,"height":1396},"images/portfolio_rafael/page_21_img_2.png":{"x":148,"y":946,"width":884,"height":884},"images/portfolio_rafael/page_21_img_3.png":{"x":0,"y":424,"width":1053,"height":1496},"images/portfolio_rafael/page_21_img_4.png":{"x":95,"y":822,"width":1038,"height":1038},"images/portfolio_rafael/page_22_img_1.png":{"x":0,"y":273,"width":468,"height":468},"images/portfolio_rafael/page_22_img_2.png":{"x":0,"y":613,"width":1053,"height":1053},"images/portfolio_rafael/page_23_img_1.png":{"x":0,"y":613,"width":1053,"height":1053},"images/portfolio_rafael/page_3_img_1.png":{"x":0,"y":152,"width":756,"height":1282},"images/portfolio_rafael/page_7_img_1.png":{"x":240,"y":835,"width":295,"height":295},"images/portfolio_rafael/page_7_img_2.png":{"x":0,"y":0,"width":648,"height":1296},"images/portfolio_rafael/page_7_img_3.png":{"x":0,"y":432,"width":864,"height":864},"images/portfolio_rafael/page_7_img_4.png":{"x":129,"y":319,"width":806,"height":806},"images/portfolio_rafael/page_8_img_1.png":{"x":0,"y":223,"width":1080,"height":1093},"images/portfolio_rafael/page_8_img_2.png":{"x":0,"y":175,"width":756,"height":859},"images/portfolio_rafael/page_8_img_3.png":{"x":83,"y":205,"width":548,"height":548},"images/portfolio_rafael/page_9_img_1.png":{"x":0,"y":198,"width":972,"height":1330},"images/portfolio_rafael/page_9_img_2.png":{"x":0,"y":59,"width":540,"height":1020},"images/portfólio_semino_antigo/image_1.png":{"x":0,"y":0,"width":900,"height":1280},"images/portfólio_semino_antigo/image_10.png":{"x":38,"y":11,"width":526,"height":526},"images/portfólio_semino_antigo/image_11.png":{"x":0,"y":0,"width":480,"height":319},"images/portfólio_semino_antigo/image_12.png":{"x":0,"y":197,"width":540,"height":756},"images/portfólio_semino_antigo/image_13.png":{"x":0,"y":0,"width":960,"height":540},"images/portfólio_semino_antigo/image_14.png":{"x":0,"y":0,"width":1280,"height":853},"images/portfólio_semino_antigo/image_15.png":{"x":0,"y":0,"width":960,"height":540},"images/portfólio_semino_antigo/image_16.png":{"x":0,"y":0,"width":960,"height":540},"images/portfólio_semino_antigo/image_17.png":{"x":0,"y":369,"width":297,"height":297},"images/portfólio_semino_antigo/image_18.png":{"x":0,"y":0,"width":480,"height":320},"images/portfólio_semino_antigo/image_19.png":{"x":0,"y":0,"width":277,"height":182},"images/portfólio_semino_antigo/image_2.png":{"x":0,"y":0,"width":919,"height":585},"images/portfólio_semino_antigo/image_20.png":{"x":0,"y":0,"width":640,"height":960},"images/portfólio_semino_antigo/image_21.png":{"x":0,"y":0,"width":866,"height":853},"images/portfólio_semino_antigo/image_22.png":{"x":0,"y":0,"width":828,"height":637},"images/portfólio_semino_antigo/image_23.png":{"x":0,"y":0,"width":242,"height":195},"images/portfólio_semino_antigo/image_24.png":{"x":0,"y":0,"width":1169,"height":853},"images/portfólio_semino_antigo/image_25.png":{"x":0,"y":0,"width":960,"height":791},"images/portfólio_semino_antigo/image_26.png":{"x":0,"y":0,"width":540,"height":540},"images/portfólio_semino_antigo/image_27.png":{"x":0,"y":141,"width":678,"height":678},"images/portfólio_semino_antigo/image_28.png":{"x":0,"y":0,"width":768,"height":512},"images/portfólio_semino_antigo/image_3.png":{"x":0,"y":0,"width":480,"height":480},"images/portfólio_semino_antigo/image_4.png":{"x":0,"y":0,"width":1280,"height":1280},"images/portfólio_semino_antigo/image_5.png":{"x":0,"y":0,"width":1280,"height":853},"images/portfólio_semino_antigo/image_6.png":{"x":0,"y":22,"width":206,"height":206},"images/portfólio_semino_antigo/image_7.png":{"x":1,"y":0,"width":915,"height":640},"images/portfólio_semino_antigo/image_8.png":{"x":276,"y":173,"width":243,"height":243},"images/portfólio_semino_antigo/image_9.png":{"x":0,"y":0,"width":540,"height":540}}

if __name__ == "__main__":
    for rel_path, crop in full_results.items():
        apply_precision_crop(rel_path, crop)
